<template>
  <div class="h-full overflow-hidden bg-white rounded-xl relative">
    <div
      @scroll="onScrollMessage"
      id="list-message"
      class="pt-14 pb-5 px-4 gap-1 flex flex-col h-full overflow-y-auto bg-[#0015810f] rounded-xl"
    >
      <div
        v-if="is_loading"
        class="relative z-10"
      >
        <div class="fixed left-1/2 -translate-x-1/2">
          <Loading class="mx-auto" />
        </div>
      </div>
      <HeaderChat />
      <div
        v-for="(message, index) of messageStore.list_message"
        class="relative"
      >
        <TimeSplit
          :before_message="messageStore.list_message?.[index - 1]"
          :now_message="message"
        />
        <div
          :class="{
            'py-2': ['client', 'page', 'note'].includes(message.message_type),
          }"
          class="flex gap-1 relative"
        >
          <div
            v-if="
              (message.message_type === 'client' && !message.ad_id) ||
              message.fb_post_id
            "
            class="flex-shrink-0"
          >
            <ClientAvatar
              :conversation="conversationStore.select_conversation"
              class="w-8 h-8"
            />
          </div>
          <div
            :class="{
              'items-end':
                ['page', 'note'].includes(message.message_type) ||
                message.ad_id,
            }"
            class="relative flex flex-col w-full"
          >
            <MessageItem
              v-if="
                ['client', 'activity', 'page', 'note'].includes(
                  message.message_type
                ) && !message.ad_id
              "
              :message
              :message_index="index"
            />

            <!-- <div
              v-if="
                ['client', 'activity'].includes(message.message_type) &&
                !message.ad_id
              "
              class="message-size group relative"
            >
              <MessageDate :time="message.time || message.createdAt" />
              <ReplyMessage
                v-if="message?.snap_replay_message"
                :message="message?.snap_replay_message"
              />
              <ClientTextMessage
                v-if="message.message_text || message.postback_title"
                :current_message="message"
                :current_index="index"
                :list_message="messageStore.list_message"
              />
              <AttachmentMessage
                v-else-if="message.message_attachments?.length"
                :message="message"
                type="CLIENT"
              />
              <UnsupportMessage v-else />
              <SlowReply
                v-if="
                  calcIsClientRepSlow(
                    message?.fb_page_id,
                    message?.time || message?.createdAt,
                    index
                  )
                "
                :now_message="message"
                :next_message="messageStore.list_message?.[index + 1]"
              />
            </div>
            <div
              v-else-if="message.message_type === 'page'"
              class="message-size group relative"
            >
              <MessageDate
                v-if="message.time"
                class="right-0"
                :time="message.time"
                :info="parserStaffName(message.message_metadata)"
              />
              <ReplyMessage
                v-if="message?.snap_replay_message"
                :message="message?.snap_replay_message"
              />
              <template
                v-if="
                  message.message_text || message.message_attachments?.length
                "
              >
                <PageTextMessage
                  v-if="message.message_text"
                  :current_message="message"
                  :current_index="index"
                  :list_message="messageStore.list_message"
                />
                <template v-if="message.message_attachments?.length">
                  <AttachmentMessage
                    v-if="
                      !['template', 'fallback', 'receipt'].includes(
                        message.message_attachments?.[0]?.type || ''
                      )
                    "
                    :message="message"
                    type="PAGE"
                  />
                  <ChatbotMessage
                    v-else
                    :message_chatbot="message.message_attachments?.[0]"
                  />
                </template>
              </template>
              <UnsupportMessage v-else />
            </div>
            <div
              v-else-if="message.message_type === 'note'"
              class="message-size group relative"
            >
              <MessageDate
                v-if="message.createdAt"
                class="right-0"
                :time="message.createdAt"
                :info="parserStaffName(message.message_metadata)"
              />
              <NoteMessage
                v-if="message.message_text"
                :text="message.message_text"
              />
              <UnsupportMessage v-else />
            </div> -->

            <div
              v-else-if="message.message_type === 'system'"
              class="text-center px-20"
            >
              <SystemMessage
                v-if="message.message_text"
                :text="message.message_text"
              />
              <UnsupportMessage v-else />
            </div>
            <AdMessage
              v-else-if="message.message_type === 'client' && message.ad_id"
              :ad_id="message.ad_id"
            />
            <FacebookPost
              v-else-if="
                message.platform_type === 'FB_POST' && message.fb_post_id
              "
              :fb_post_id="message.fb_post_id"
            />
            <UnsupportMessage v-else />
            <DoubleCheckIcon
              v-if="isLastPageMessage(message, index)"
              class="w-3 h-3 text-green-500 absolute -bottom-1.5 -right-11"
            />
          </div>
          <PageStaffAvatar
            :message
            v-if="
              ['page', 'note'].includes(message.message_type) || message.ad_id
            "
          />
          <ClientRead
            @change_last_read_message="visibleFirstClientReadAvatar"
            :time="message.time"
          />
        </div>
        <StaffRead
          @change_last_read_message="visibleLastStaffReadAvatar"
          :time="message.time"
        />
      </div>
      <div
        v-for="message of messageStore.send_message_list"
        class="relative group flex flex-col gap-1 items-end py-2"
      >
        <div class="message-size group relative flex gap-1 items-end">
          <PageTempTextMessage
            :text="message.text"
            :class="{
              'border border-red-500': message.error,
            }"
          />
          <StaffAvatar
            :id="chatbotUserStore.chatbot_user?.fb_staff_id"
            class="w-6 h-6 rounded-oval flex-shrink-0"
          />
        </div>
        <SendStatus :is_error="message.error" />
      </div>
    </div>
  </div>
</template>
<script setup lang="ts">
import { computed, nextTick, onMounted, onUnmounted, ref, watch } from 'vue'
import {
  useConversationStore,
  useMessageStore,
  useCommonStore,
  useChatbotUserStore,
} from '@/stores'
import { flow } from '@/service/helper/async'
import { read_message } from '@/service/api/chatbox/n4-service'
import { toastError } from '@/service/helper/alert'
import { calcIsClientRepSlow, scrollToBottomMessage } from '@/service/function'
import { debounce, findLastIndex, remove, size } from 'lodash'

import Loading from '@/components/Loading.vue'
import MessageDate from '@/views/ChatWarper/Chat/CenterContent/MessageList/MessageDate.vue'
import TimeSplit from '@/views/ChatWarper/Chat/CenterContent/MessageList/TimeSplit.vue'
import ChatbotMessage from '@/views/ChatWarper/Chat/CenterContent/MessageList/ChatbotMessage.vue'
import AttachmentMessage from '@/views/ChatWarper/Chat/CenterContent/MessageList/AttachmentMessage.vue'
import UnsupportMessage from '@/views/ChatWarper/Chat/CenterContent/MessageList/UnsupportMessage.vue'
import ClientTextMessage from '@/views/ChatWarper/Chat/CenterContent/MessageList/ClientTextMesage.vue'
import PageTextMessage from '@/views/ChatWarper/Chat/CenterContent/MessageList/PageTextMessage.vue'
import PageTempTextMessage from '@/views/ChatWarper/Chat/CenterContent/MessageList/PageTempTextMessage.vue'
import SendStatus from '@/views/ChatWarper/Chat/CenterContent/MessageList/SendStatus.vue'
import SystemMessage from '@/views/ChatWarper/Chat/CenterContent/MessageList/SystemMessage.vue'
import NoteMessage from '@/views/ChatWarper/Chat/CenterContent/MessageList/NoteMessage.vue'
import ClientRead from '@/views/ChatWarper/Chat/CenterContent/MessageList/ClientRead.vue'
import StaffRead from '@/views/ChatWarper/Chat/CenterContent/MessageList/StaffRead.vue'
import AdMessage from '@/views/ChatWarper/Chat/CenterContent/MessageList/AdMessage.vue'
import FacebookPost from '@/views/ChatWarper/Chat/CenterContent/MessageList/FacebookPost.vue'
import ReplyMessage from '@/views/ChatWarper/Chat/CenterContent/MessageList/ReplyMessage.vue'
import PageStaffAvatar from '@/views/ChatWarper/Chat/CenterContent/MessageList/PageStaffAvatar.vue'
import ClientAvatar from '@/components/Avatar/ClientAvatar.vue'
import StaffAvatar from '@/components/Avatar/StaffAvatar.vue'
import SlowReply from '@/views/ChatWarper/Chat/CenterContent/MessageList/SlowReply.vue'
import HeaderChat from '@/views/ChatWarper/Chat/CenterContent/MessageList/HeaderChat.vue'
import MessageItem from '@/views/ChatWarper/Chat/CenterContent/MessageList/MessageItem.vue'

import DoubleCheckIcon from '@/components/Icons/DoubleCheck.vue'

import type { MessageInfo } from '@/service/interface/app/message'
import type { CbError } from '@/service/interface/function'
import type { DebouncedFunc } from 'lodash'

/**dữ liệu từ socket */
interface CustomEvent extends Event {
  detail?: MessageInfo
}

const conversationStore = useConversationStore()
const messageStore = useMessageStore()
const commonStore = useCommonStore()
const chatbotUserStore = useChatbotUserStore()

/**danh sách tin nhắn hiện tại */
// const list_message = ref<MessageInfo[]>([])
/**có đang load tin nhắn hay không */
const is_loading = ref(false)
/**gắn cờ đã load hết dữ liệu */
const is_done = ref(false)
/**phân trang */
const skip = ref(0)
/**phân trang */
const LIMIT = 20
/**giá trị scroll_height trước đó của danh sách tin nhắn */
let old_scroll_height = ref(0)
/**danh sách các hàm debounce cho từng staff */
const list_debounce_staff = ref<{
  [index: string]: DebouncedFunc<any>
}>({})

watch(
  () => conversationStore.select_conversation,
  (new_val, old_val) => {
    // * reset danh sách tin nhắn khi đổi khách hàng
    messageStore.list_message = []

    // * reset danh sách tin nhắn chờ
    messageStore.send_message_list = []

    // reset cờ đã load hết dữ liệu
    is_done.value = false

    // reset phân trang
    skip.value = 0

    getListMessage(true)
  }
)
/**vị trí của tin nhắn cuối cùng nhân viên gửi */
const last_client_message_index = computed(() =>
  findLastIndex(
    messageStore.list_message,
    m => m.message_type === 'page' && !!m.message_metadata
  )
)

onMounted(() =>
  window.addEventListener('chatbox_socket_message', onRealtimeHandleMessage)
)
onUnmounted(() =>
  window.removeEventListener('chatbox_socket_message', onRealtimeHandleMessage)
)

/**kiểm tra xem tin nhắn này có phải là tin nhắn cuối cùng của nhân viên gửi không */
function isLastPageMessage(message: MessageInfo, index: number) {
  // chỉ tính tin nhắn của trang
  if (message.message_type !== 'page') return false
  // phải là tin do nhân viên gửi
  if (!message.message_metadata) return false

  // nếu là tin nhắn cuối cùng của nhân viên gửi
  return index === last_client_message_index.value
}
/**phân tích tên nv từ meta */
function parserStaffName(meta?: string) {
  return meta?.split('__')?.[1] || ''
}
/**xử lý socket message */
function onRealtimeHandleMessage({ detail }: CustomEvent) {
  if (!detail) return

  // nếu không phải của khách hàng đang chọn thì chặn
  if (
    detail.fb_page_id !== conversationStore.select_conversation?.fb_page_id ||
    detail.fb_client_id !== conversationStore.select_conversation.fb_client_id
  )
    return

  // nếu là dạng comment bài post thì loại bỏ các post cũ, để post mới sẽ lên đầu
  if (size(detail.comment))
    remove(messageStore.list_message, message => message._id === detail._id)

  // thêm tin nhắn vào danh sách
  messageStore.list_message.push(detail)

  // xử lý khi gặp trường hợp phát hiện tin nhắn chờ
  if (detail?.message_mid)
    remove(
      messageStore.send_message_list,
      message => message.message_id === detail?.message_mid
    )

  scrollToBottomMessage()
}
/**lắng nghe sự kiện khi scroll danh sách tin nhắn */
function onScrollMessage($event: Event) {
  handleButtonToBottom($event as UIEvent)

  loadMoreMessage($event as UIEvent)
}
/**ẩn hiện nút về bottom */
function handleButtonToBottom($event: UIEvent) {
  /**div chưa danh sách tin nhắn */
  const LIST_MESSAGE = $event?.target as HTMLElement

  let { scrollHeight, scrollTop, clientHeight } = LIST_MESSAGE

  /**giá trị khoảng cách scroll với bottom */
  const SCROLL_BOTTOM = scrollHeight - scrollTop - clientHeight

  /**
   * xử lý như thế này để giảm tải việc thay đổi store liên tục, nếu không
   * có khả năng bị lag, treo, khi có nhiều nơi watch store, send event mà
   * mình không phát hiện ra
   */
  if (SCROLL_BOTTOM > 400 && !messageStore.is_show_to_bottom) {
    messageStore.is_show_to_bottom = true
  }
  if (SCROLL_BOTTOM <= 400 && messageStore.is_show_to_bottom) {
    messageStore.is_show_to_bottom = false
  }
}
/**load thêm dữ liệu khi lăn chuột lên trên */
function loadMoreMessage($event: UIEvent) {
  /**div chưa danh sách tin nhắn */
  const LIST_MESSAGE = $event?.target as HTMLElement

  if (!LIST_MESSAGE) return

  /**giá trị scroll top hiện tại */
  const SCROLL_TOP = LIST_MESSAGE?.scrollTop

  // nếu đang chạy hoặc đã hết dữ liệu thì thôi
  if (is_loading.value || is_done.value) return

  // infinitve loading scroll
  if (SCROLL_TOP < 300) getListMessage()
}
/**đọc danh sách tin nhắn */
function getListMessage(is_scroll?: boolean) {
  // nếu đang mất mạng thì không cho gọi api
  if (!commonStore.is_connected_internet) return

  /**id tin nhắn trên đầu của lần loading trước */
  let old_first_message_id = messageStore.list_message?.[0]?._id

  flow(
    [
      // * bật loading
      (cb: CbError) => {
        is_loading.value = true

        cb()
      },
      // * đọc dữ liệu từ api
      (cb: CbError) =>
        read_message(
          {
            page_id: conversationStore.select_conversation?.fb_page_id,
            client_id: conversationStore.select_conversation?.fb_client_id,
            skip: skip.value,
            limit: LIMIT,
          },
          (e, r) => {
            if (e) return cb(e)
            if (!r || !r.length) {
              // gắn cờ đã load hết dữ liệu
              is_done.value = true

              return cb()
            }

            // đảo chiều mảng
            r.reverse()

            // thêm dữ liệu đã đảo chiều lên đầu
            messageStore.list_message.unshift(...r)

            // trang tiếp theo
            skip.value += LIMIT

            cb()
          }
        ),
      // * làm cho scroll to top mượt hơn
      (cb: CbError) => {
        // chạy infinitve loading scroll
        nextTick(() => {
          // lấy div chưa danh sách tin nhắn
          const LIST_MESSAGE = document.getElementById('list-message')

          if (!LIST_MESSAGE) return

          // nếu có scroll height, thì scroll lại div cho về đúng giá trị trước -> gần như mượt
          if (old_scroll_height.value)
            LIST_MESSAGE.scrollTop =
              LIST_MESSAGE.scrollHeight -
              old_scroll_height.value +
              LIST_MESSAGE.scrollTop

          // lấy giá trị mới
          old_scroll_height.value = LIST_MESSAGE.scrollHeight
        })

        cb()
      },
    ],
    e => {
      // tắt loading
      is_loading.value = false

      // load lần đầu thì tự động cuộn xuống
      if (is_scroll) {
        /**
         * chạy logic infinitve loading scroll
         * lần đầu tiên load tin nhắn, mà phát hiện tin nhắn vẫn còn,
         * thì load thêm 1 lần tin nhắn nữa, để tránh lỗi scroll không mượt
         */
        if (messageStore.list_message.length >= LIMIT) getListMessage()

        scrollToBottomMessage()

        setTimeout(() => scrollToBottomMessage(), 500)
      }

      if (e) return toastError(e)
    }
  )
}
/**
 * chỉ hiển thị avatar khách hàng đã đọc đến tin nhắn đầu tiên
 * vì cùng mội thời điểm sẽ có nhiều div thoả mãn điều kiện gửi event
 * nên sử dụng debounce để chỉ chạy event cuối cùng, tránh bị lặp code
 */
const visibleFirstClientReadAvatar = debounce(() => {
  const FIRST_AVATAR = document.querySelector(
    '.mesage-client-read'
  ) as HTMLElement

  if (!FIRST_AVATAR) return

  // thêm css để hiển thị
  FIRST_AVATAR.style.display = 'block'
}, 50)
/**
 * chỉ hiển thị avatar nhân viên đã đọc tin nhắn cuối cùng
 * vì cùng mội thời điểm sẽ có nhiều div thoả mãn điều kiện gửi event
 * nên sử dụng debounce để chỉ chạy event cuối cùng, tránh bị lặp code
 */
function visibleLastStaffReadAvatar(staff_id: string) {
  // init hàm debounce cho từng staff nếu không tồn tại
  if (!list_debounce_staff.value[staff_id])
    list_debounce_staff.value[staff_id] = debounce(doVisibleAvatar, 50)

  // chạy hàm debounce
  list_debounce_staff.value[staff_id](staff_id)

  /**hiển thị avatar staff cuối cùng */
  function doVisibleAvatar(staff_id: string) {
    /**toàn bộ các div avatar */
    const LIST_AVATAR: HTMLElement[] = Array.from(
      document.querySelectorAll(`.message-staff-read-${staff_id}`)
    )

    // lặp qua toàn bộ các div
    LIST_AVATAR.forEach((element: any, i: number) => {
      // reset ẩn toàn bộ các avatar hiện tại
      if (i < LIST_AVATAR.length - 1) element.style.display = 'none'
      // chỉ hiển thị avatar cuối cùng
      else element.style.display = 'block'
    })
  }
}
</script>
<style scoped lang="scss">
.message-size {
  @apply w-fit max-w-96;
}
</style>
