<template>
  <DashboardLayout class_content="flex flex-col gap-3 relative">
    <template #menu><Menu /></template>
    <template #content>
      <HotAlert
        :codes="[
          'ALMOST_EXPIRED_PACKAGE',
          'TOPUP_WAITING',
          'ALMOST_REACH_QUOTA_AI',
          'CHANGE_PAGE_OWNER',
          'LOCK_FEATURE',
          'PAGE_EXPIRED_SESSION',
        ]"
      />
      <div
        class="gap-2 flex flex-col md:flex-row md:justify-between flex-shrink-0"
      >
        <div
          class="text-lg font-semibold flex items-center gap-2 flex-grow min-w-0"
        >
          <FlagIcon class="size-5 flex-shrink-0" />
          <div class="flex-shrink-0">
            {{ $t('Trình quản lý Trang') }}
          </div>
          <AssignGroup
            v-if="!orgStore.isAdminOrg() && !orgStore.is_selected_all_org"
          />
        </div>
        <div
          class="grid grid-cols-2 gap-5 md:flex md:justify-between flex-shrink-0"
        >
          <Search
            class="md:w-52"
            v-model="selectPageStore.search"
            :placeholder="$t('v1.common.page_search_placeholder')"
          />
          <SelectOrg is_allow_all />
        </div>
      </div>
      <div
        v-if="selectPageStore.is_loading"
        class="absolute left-1/2 -translate-x-1/2 top-14"
      >
        <Loading class="mx-auto" />
      </div>
      <template v-if="orgStore.is_selected_all_org">
        <AllOrg />
        <GroupPageAction />
      </template>
      <template v-else>
        <EmptyPage
          v-if="
            !(
              pageStore.countActivePage() ||
              orgStore.selected_org_group?.[orgStore.selected_org_id || '']
            ) && !selectPageStore.is_loading
          "
          tab="PAGE"
        />
        <!-- v-else -->
        <div
          :class="{
            'pb-16': selectPageStore.is_group_page_mode,
          }"
          class="overflow-y-auto flex flex-col gap-3"
        >
          <SelectGroup v-if="orgStore.isAdminOrg()" />
          <SkeletonGroupPage v-if="selectPageStore.is_loading" />
          <!-- <GroupPage
            filter="RECENT"
            :icon="ClockIcon"
            :title="$t('v1.common.recent')"
            tab="PAGE"
          /> -->
          <GroupPage
            filter="FB_MESS"
            :icon="FacebookIcon"
            :title="$t('v1.common.fb_mess')"
            tab="FB_MESS"
          />
          <GroupPage
            filter="WEBSITE"
            :icon="WebIcon"
            :title="$t('v1.common.website')"
            tab="WEBSITE"
          />
          <GroupPage
            filter="FB_INSTAGRAM"
            :icon="InstagramIcon"
            :title="`Instagram`"
            tab="FB_INSTAGRAM"
          />

          <GroupPage
            filter="ZALO"
            :icon="ZaloIcon"
            :title="`Zalo`"
            tab="ZALO"
          />

          <GroupPageAction />
        </div>
      </template>
    </template>
  </DashboardLayout>
</template>

<script setup lang="ts">
import { preGoToChat } from '@/service/function'
import { nonAccentVn } from '@/service/helper/format'
import { useOrgStore, usePageStore, useSelectPageStore } from '@/stores'
import { useEmbedChat } from '@/views/composables/useEmbedChat'
import { usePageManager } from '@/views/Dashboard/composables/usePageManager'
import {
  KEY_GO_TO_CHAT_FUNCT,
  KEY_SORT_LIST_PAGE_FUNCT,
} from '@/views/Dashboard/SelectPage/symbol'
import {
  KEY_GET_CHATBOT_USER_FUNCT
} from '@/views/Dashboard/symbol'
import { map } from 'lodash'
import { computed, inject, onMounted, provide, watch } from 'vue'
import { useI18n } from 'vue-i18n'
import { useRoute, useRouter } from 'vue-router'

import HotAlert from '@/components/HotAlert.vue'
import Loading from '@/components/Loading.vue'
import DashboardLayout from '@/components/Main/Dashboard/DashboardLayout.vue'
import Search from '@/components/Main/Dashboard/Search.vue'
import SelectOrg from '@/components/Main/Dashboard/SelectOrg.vue'
import AllOrg from '@/views/Dashboard/SelectPage/AllOrg.vue'
import AssignGroup from '@/views/Dashboard/SelectPage/AssignGroup.vue'
import EmptyPage from '@/views/Dashboard/SelectPage/EmptyPage.vue'
import GroupPage from '@/views/Dashboard/SelectPage/GroupPage.vue'
import GroupPageAction from '@/views/Dashboard/SelectPage/GroupPageAction.vue'
import Menu from '@/views/Dashboard/SelectPage/Menu.vue'
import SelectGroup from '@/views/Dashboard/SelectPage/SelectGroup.vue'
import SkeletonGroupPage from '@/views/Dashboard/SkeletonGroupPage.vue'

import FacebookIcon from '@/components/Icons/Facebook.vue'
import InstagramIcon from '@/components/Icons/Instagram.vue'
import WebIcon from '@/components/Icons/Web.vue'
import ZaloIcon from '@/components/Icons/Zalo.vue'
import { FlagIcon } from '@heroicons/vue/24/solid'

import type { PageData } from '@/service/interface/app/page'

const { t: $t } = useI18n()
const pageStore = usePageStore()
const selectPageStore = useSelectPageStore()
const $router = useRouter()
const $route = useRoute()
const orgStore = useOrgStore()

/** composable */
const { toggleModalConnectPage, getOrgPages } = usePageManager()

/**hàm load lại thông tin chatbot user từ component cha */
const getMeChatbotUser = inject(KEY_GET_CHATBOT_USER_FUNCT)
/**
 * lấy danh sách trang đã kích hoạt
 * @deprecated sử dụng getOrgPages trong composable usePageManager
 * */
// const getOrgPages = inject(KEY_GET_ORG_PAGES_FN)
/**
 * mở modal connect page
 * @deprecated sử dụng toggleModalConnectPage trong composable usePageManager
 */
// const toggleModalConnectPage = inject(KEY_TOGGLE_MODAL_CONNECT_PAGE_FUNCT)

// cắm bong bóng chat vào trang
useEmbedChat()

computed(() => selectPageStore.current_menu)

// xử lý khi thay đổi từ tất cả tổ chức xuống 1 tổ chức
watch(
  [() => orgStore.is_selected_all_org, () => orgStore.selected_org_id],
  (
    [new_is_selected_all_org, new_selected_org_id],
    [old_is_selected_all_org, old_selected_org_id]
  ) => {
    // nếu chọn tất cả tổ chức thỉ thôi
    if (new_is_selected_all_org) return

    // nếu cờ chọn tất cả tổ chức không đổi thì thôi
    if (new_is_selected_all_org === old_is_selected_all_org) return

    // nếu chọn 1 tổ chức nhưng khác tổ chức cũ thì thôi (chạy ở watch khác)
    if (new_selected_org_id !== old_selected_org_id) return

    // load danh sách page
    getOrgPages?.(orgStore.selected_org_id)
  }
)

// nếu thay đổi tổ chức, thì chọn lại danh sách trang
watch(
  () => orgStore.selected_org_id,
  () => {
    // nếu đang chọn all thì thôi
    if (orgStore.is_selected_all_org) return

    // load danh sách page
    getOrgPages?.(orgStore.selected_org_id)
  }
)

onMounted(() => {
  /**
   * load lại info của chatbot user
   * phòng trường hợp user mới được kích hoạt gói
   * nhưng sẽ bị gọi api 2 lần lúc đầu
   */
  getMeChatbotUser?.()

  // kích hoạt tự động mở kết nối nền tảng nếu cần
  triggerConnectPlatform()
})

/**kích hoạt tự động mở kết nối nền tảng nếu cần */
function triggerConnectPlatform() {
  // nếu không có cờ thì thôi
  if (!$route.query.connect_page) return

  /** cờ kiểm tra mở kết nối */
  const CONNECT_PAGE = $route.query.connect_page?.toString() || ''

  // mở modal connect zalo
  toggleModalConnectPage?.(CONNECT_PAGE)
}
/**chuyển đến trang chat */
function goToChat() {
  // chuyển đến trang chat
  preGoToChat(() => $router.push('/chat'))
}
/**sắp xếp page gắn sao lên đầu */
function sortListPage(): PageData[] {
  // object -> array
  let array_page_list = map(pageStore.active_page_list, page_data => {
    // tạo data key cho vitual scroll
    page_data.data_key = page_data.page?.fb_page_id

    return page_data
  })

  /**
   * lọc các page phù hợp điều kiện tìm kiếm
   * - tìm kiếm theo tên hoặc id
   */
  array_page_list = array_page_list.filter(page_data => {
    // chuyển dữ liệu tìm kiếm về tiếng việt không dấu
    let formated_page_name = nonAccentVn(page_data.page?.name || '')
    let page_id = page_data.page?.fb_page_id || ''
    let formated_search_value = nonAccentVn(selectPageStore.search)

    // tìm kiếm theo tên hoặc id
    if (
      formated_page_name.includes(formated_search_value) ||
      page_id.includes(formated_search_value)
    )
      return true

    return false
  })

  /**
   * sắp xếp lại mảng theo quy tắc:
   * - ưu tiên sắp xếp các page được chọn trước
   * - sau đó sắp xếp theo các page được đánh dấu sao
   */
  let sort_priority_page_list = array_page_list.sort((page_a, page_b) => {
    /**sắp xếp các page có gắn dấu sao */
    const sortPriority = () => {
      const priority_a = page_a.page?.is_priority
      const priority_b = page_b.page?.is_priority

      // nếu cả 2 page đều gắn dấu sao thì giữ nguyên vị trí
      if (priority_a && priority_b) return 0

      // nếu chỉ page 1 gắn dấu sao thì ưu tiên page 1
      if (priority_a) return 1

      // nếu chỉ page 2 gắn dấu sao thì ưu tiên page 2
      if (priority_b) return -1

      // nếu không có page nào gắn sao thì giữ nguyên vị trí
      return 0
    }

    /**sắp xếp các page được chọn */
    const sortPageIsSelected = () => {
      const selected_a =
        pageStore.selected_page_id_list?.[page_a.page?.fb_page_id || '']
      const selected_b =
        pageStore.selected_page_id_list?.[page_b.page?.fb_page_id || '']

      // nếu cả 2 page được chọn thì tính dấu sao
      if (selected_a && selected_b) return sortPriority()

      // nếu chỉ page 1 được chọn thì chọn page 1
      if (selected_a) return 1

      // nếu chỉ page 2 được chọn thì chọn page 2
      if (selected_b) return -1

      // nếu không có page nào được chọn thì tính độ ưu tiên
      return sortPriority()
    }

    return sortPageIsSelected()
  })

  // đảo chiều mảng, vì hàm sort chạy theo ASC
  return sort_priority_page_list.reverse()
}

// xuất hàm cho component con sử dụng
provide(KEY_GO_TO_CHAT_FUNCT, goToChat)
provide(KEY_SORT_LIST_PAGE_FUNCT, sortListPage)
</script>
